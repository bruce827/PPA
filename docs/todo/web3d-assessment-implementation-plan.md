# Web3D 项目评估实施计划（基于 PRD V1.1.0）

目标：在现有评估系统中上线 Web3D 专属评估模块，覆盖配置管理、评估流程（Step1-5）、工作量计算、历史项目与导出。前后端同时交付，保持现有模块行为不变。

## 范围与原则
- 范围内：Web3D 评估的路由/UI、API、数据库表/字段、工作量与风险计算、导出、配置管理独立 Sheet、历史项目过滤/详情/重评。
- 范围外：AI 自动填充（留作 V1.2+）、模型预检工具、传统项目评估的改造（保持原样）。
- 原则：复用现有三层结构（controllers → services → models）、前端布局与 Overview 组件框架；新增逻辑需明确区分 `project_type=web3d`。

## 里程碑与排期（预估 14 人天）
- Phase 0（0.5d）需求澄清与设计冻结：评估项/工作量模板确认；表结构与接口签字。
- Phase 1（3d）基础框架：数据库迁移脚本、后端 API 骨架、前端路由与页面骨架。
- Phase 2（2d）配置管理：Web3D 风险配置页面 + 工作量模板配置 + 种子数据。
- Phase 3（5d）新建评估：Step1-5 表单、风险评分、工作量估算、报价生成。
- Phase 4（2d）历史项目：列表/详情/重评串联；导出/重新计算。
- Phase 5（1.5d）测试与文档：Jest+Supertest 覆盖、前端冒烟脚本、用户说明；预留 0.5d 验收修订。

## 交付物
- 前端：`/web3d` 路由及页面（New/History/Detail）、`/config/web3d-risk` 配置页、导出 PDF/Excel 支持。
- 后端：Web3D 相关 REST API、数据库表变更（`project_type` 字段 + `web3d_risk_items`、`web3d_workload_templates`）、计算服务。
- 数据：初始 Web3D 风险项与工作量模板种子脚本；测试库同步。
- 文档：README/PRD 补充、接口示例、使用说明。

## 工作分解

### 数据库与迁移
- `projects` 表新增 `project_type TEXT DEFAULT 'standard'`；补全索引（按创建时间/类型）。
- 新建 `web3d_risk_items`、`web3d_workload_templates` 表（字段按 PRD），加入 `created_at/updated_at` 默认值；同步测试库。
- 提供迁移脚本（兼容重复执行）与 `init-db.js` 更新；在测试脚本中确保 `NODE_ENV=test` 指向 `ppa.test.db`。
- 预置种子：PRD 列表中的风险项/options/权重与工作量模板。

### 后端接口与服务
- 路由分组：`/api/web3d/config/*`、`/api/web3d/projects/*`，复用现有错误处理与校验中间件。
- Config APIs：风险项 CRUD、工作量模板 CRUD；options/weight 校验（必填、范围、唯一约束）。
- Project APIs：创建/更新/查询/删除 Web3D 项目（含 `assessment_details_json` 与 `project_type=web3d`）；分页过滤按类型。
- 计算服务：实现 Step1-3 风险评分汇总、Step4 工作量估算公式 `(A+B+C)*D`，D 支持混合方案 +0.3 等特判；成本 = 人日单价 × 工时 × 风险系数。
- 导出：复用现有导出模块，增加 Web3D 模板（风险明细 + 工作量明细 +报价）；`/projects/:id/export` 支持类型区分。
- 日志与错误：沿用统一错误处理中间件；记录计算耗时，确保 <500ms 目标，必要时缓存配置。

### 前端路由与页面
- `.umirc.ts` 路由新增 `/web3d` 分组与 `/config/web3d-risk`；菜单与现有结构一致。
- 新建评估（`/web3d/new`）：
  - Step1-3 表单：技术路线/场景/业务/部署 + 数据资产 + 视觉/交互/性能选项；动态校验（移动端禁止选 Unity/Unreal）。
  - Step4 工作量估算：基于模板可编辑行（单位/数量/单价/小计）；支持自定义行/删除；A/B/C 分类。
  - Step5 Overview：展示风险评分、A/B/C/D 明细、总工时、报价；支持保存草稿/提交。
  - 状态管理：复用现有 form store 或新建局部 Zustand/Redux slice；保存时串联 API。
- 历史项目（`/web3d/history`、`/web3d/detail/:id`）：
  - 列表：按 project_type 过滤；展示场景、技术路线、风险等级、报价。
  - 详情：Tab 显示风险评分、工作量明细、报价概览；支持导出与“重新评估”跳转到 New（预填数据）。
- 配置页（`/config/web3d-risk`）：
  - Step 分组展示、权重与 options 编辑、排序；支持新增/编辑/删除；保存后刷新缓存。
  - 工作量模板配置：类别/单位/基准工时维护；提供校验提示。
- UI/UX：沿用 Ant Design + Steps + Table；特殊交互（Raycaster/性能基准等）以文本提示/Tag 呈现；确保移动端表单适配。

### 计算与业务规则
- 风险评分：按 PRD 权重与选项值计算总分及等级，混合方案/移动端等高风险标记；结果写入项目详情。
- 工作量：支持按模板自动生成行；数量可编辑；角色/单价来源于“参数配置/角色与单价管理”，不在 Step1 输入日单价；混合方案额外系数叠加；支持手动调整风险系数。
- 工作项与角色选择：工作项来源于 Web3D 工作量模板；角色可多选并取均价（不可手改）；交付系数参与小计=人天×交付系数×均价。
- 性能指标提示：在 Step3 显示 FPS/DrawCall/面数基准线，存入 assessment details。

### 数据初始化与兼容
- 数据迁移：历史 `projects` 默认标记为 `standard`；前端/后端查询默认过滤 `standard` + `web3d`。
- 种子脚本：`npm run seed:web3d`（或在 init-db 中自动写入）；幂等写入风险项/模板。
- 文档化：在 README/PRD 中标注新增脚本与路由。

### 测试与质量
- 后端：Supertest 覆盖 Config CRUD、项目创建/更新/计算/导出；性能断言 <500ms；混合方案/移动端高风险分支用例。
- 前端：关键流程冒烟（新建 → 保存/提交 → 详情/导出）、配置页 CRUD、历史列表过滤；可选添加 Playwright/简单 Jest 组件测试。
- 数据：校验 options 解析、JSON 字段存取、风险/工作量计算结果快照。

### 发布与回滚
- 功能开关：前端菜单可通过环境变量开关；后端在路由层增加 `ENABLE_WEB3D` 判断（默认开启）。
- 回滚策略：数据库新增表/字段为前向兼容；如需关闭仅隐藏路由与菜单。
- 上线前检查清单：迁移脚本执行、种子数据成功、前后端构建通过、核心接口 200、导出可用。

## 关键风险与应对
- 模型数据缺失/质量差：在 Step2 强制提示与风险标记；提供输入引导与备注。
- 性能指标与设备差异：在 Step3 明示基准线；支持客户自定义目标；默认阈值存储可调整。
- 计算复杂度/耗时：配置缓存 + 轻量计算函数，避免阻塞；必要时预先拉取配置。
- 导出格式差异：先复用现有模板，逐步优化 Web3D 专项表格；导出失败需兜底提示与重试。

## 验收标准
- 新建/保存/计算/导出 Web3D 项目全流程可用，项目数据持久化正确，历史列表可筛选/查看/重评。
- 配置管理可新增/编辑/删除 Web3D 风险项与工作量模板，变更后计算即时生效。
- 主要 API 响应 <500ms，前端表单校验符合 PRD 约束，导出生成内容与计算结果一致。
- 自动化测试通过（`npm test`），前端构建无错误，关键路径手工验证清单完成。

## 进展同步（2025-12-02）
- DB 已完成迁移与种子：`project_type` 字段、新建 `web3d_risk_items`/`web3d_workload_templates`，并灌入默认 16 条风险项、10 条工作量模板。
- 后端 API 已落地：Web3D config CRUD、项目 calculate/create/update/get/list/delete、导出 XLSX（内置 Web3D formatter/renderer）；工作量计算已支持新增类别 `performance`，总人天/导出同步包含 `performance_days`。
- 前端 Step1-5 对齐 PRD：Step1 新增观看距离滑块（0.5~8m，默认 0.5~1）、目标终端必填（同一行展示 GPU/终端）、模型来源选项补充“设计院可以给出BIM数据，但是需要贴图”及单行备注；Step4 类别下拉中文且含“性能与兼容性”，角色多选均价、交付系数参与小计；Step5 操作按钮收敛到右侧卡片，工作量明细列精简/对齐。
- 冒烟通过：参见 `WEB3D_SMOKE_TEST_REPORT.md`，闭环（创建 → 导出 → 删除）已验证，导出文件 `web3d-export-demo.xlsx` 可用。
- 待办：补充/运行自动化测试（Supertest/Jest 与前端冒烟）；前端构建 CI 尚未执行（本地仅手测）。
- 后续优化：交付系数的获取方式（从模板/历史项目学习，按项目类型/角色推荐并提示来源）。
- 配置页：已在参数配置 Tabs 中增加“Web3D 风险配置”，可直接维护 Web3D 风险项与工作量模板（/config/web3d-risk 仍可直达）。
- 报价/导出：基础成本=角色均价×人天×交付系数汇总，风险系数来自 Step1-3（clamp 1~3），总成本=基础成本×风险系数；导出支持 Web3D 专用格式（含角色均价/风险/工作量）。
- 后期优化：基于评估数据与模型配置，支持 AI 生成项目范围说明书（SOW）草稿，供导出/下载。
- 后期优化：历史项目详情的“评估数据”块暂时隐藏，需重新设计结构化展示或下载入口。
