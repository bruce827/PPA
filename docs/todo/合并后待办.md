# merge后代办

1. 清理过时的的库和doc
2. 优化server端的代码，review db是否都写在了module层
3. 前端码表检查，antd格式检查
4. 前端枚举常量重构：创建 `src/constants/` 目录，定义 AI 服务商枚举、业务规则常量、表单配置等
5. 重新生成prd和用户指南
5. **【严重】重构aiModelController，修复架构违规问题**
6. **【严重】重构promptTemplateController，修复架构违规问题**

---

## 5. 【严重】重构aiModelController，修复架构违规问题

**问题描述**：
`server/controllers/aiModelController.js` 存在严重的架构违规问题：

- 直接引入sqlite3，自己创建数据库连接，绕过了统一的`config/database.js`
- 直接执行SQL语句，绕过了models层
- 绕过了services层，controller直接操作数据库
- 没有使用统一的错误处理机制

**影响**：

- 数据库连接管理混乱，可能导致连接泄漏
- 业务逻辑散落在controller中，难以维护
- 无法复用已有的models和services
- 违反分层架构原则

**解决方案**：

1. 创建 `server/models/aiModelModel.js` - 封装所有AI模型相关的数据库操作
2. 创建 `server/services/aiModelService.js` - 封装业务逻辑
3. 重构 `server/controllers/aiModelController.js`：
   - 移除sqlite3直接依赖
   - 使用统一的`config/database.js`管理连接
   - 调用`aiModelService`而不是直接操作数据库
   - 使用统一的错误处理（`next(error)`）
4. 确保所有数据库操作都通过model层

**相关文件**：

- `server/controllers/aiModelController.js`（需要重构）
- 需要新建：`server/models/aiModelModel.js`
- 需要新建：`server/services/aiModelService.js`

**会影响的功能**：

- AI模型配置管理（增删改查）
- 设置当前使用的AI模型
- 测试AI模型连接
- 临时测试AI模型连接（表单内测试）
- 所有依赖当前AI模型配置的AI功能（风险评估、模块分析、工作量评估）

**测试方案**：

1. **单元测试**：
   - 测试`aiModelModel.js`的所有CRUD方法
   - 测试`aiModelService.js`的业务逻辑
   - 使用Jest + SQLite内存数据库进行隔离测试

2. **集成测试**：
   - 测试完整的API流程：创建模型→设置当前模型→测试连接→删除模型
   - 验证数据库连接统一管理，无连接泄漏
   - 测试错误处理机制是否正常工作

3. **回归测试**：
   - 验证所有AI功能（风险评估、模块分析、工作量评估）在重构后正常工作
   - 测试不同AI提供商（OpenAI、Doubao）的切换功能
   - 验证模型配置变更后，AI调用是否使用新配置

4. **性能测试**：
   - 监控数据库连接数，确保无连接泄漏
   - 测试并发请求下的稳定性

---

## 6. 【严重】重构promptTemplateController，修复架构违规问题

**问题描述**：
`server/controllers/promptTemplateController.js` 存在架构违规问题：

- 直接调用`promptTemplateModel`，绕过了services层
- 业务逻辑（如变量解析、权限检查）散落在controller中
- 没有统一的错误处理，直接使用`res.status().json()`

**影响**：

- 业务逻辑与控制器耦合，难以测试
- 无法复用业务逻辑
- 违反分层架构原则（应该Controller→Service→Model）

**解决方案**：

1. 创建 `server/services/promptTemplateService.js` - 封装业务逻辑
2. 重构 `server/controllers/promptTemplateController.js`：
   - 调用`promptTemplateService`而不是直接调用model
   - 将业务逻辑（如变量解析、权限检查）移到service层
   - 使用统一的错误处理（`next(error)`）
3. 保持model层纯粹，只负责数据访问

**相关文件**：

- `server/controllers/promptTemplateController.js`（需要重构）
- 需要新建：`server/services/promptTemplateService.js`

**会影响的功能**：

- 提示词模板管理（增删改查）
- 复制提示词模板
- 预览提示词模板（变量替换功能）
- AI风险评估、模块分析、工作量评估的提示词选择
- 模型配置中的提示词模板管理

**测试方案**：

1. **单元测试**：
   - 测试`promptTemplateService.js`的所有业务方法
   - 测试变量解析逻辑（包括必填变量检查、未使用变量检测）
   - 测试权限检查逻辑（系统模板不可修改/删除）
   - 测试复制功能是否完整复制所有字段

2. **集成测试**：
   - 测试完整的API流程：创建模板→预览→复制→更新→删除
   - 验证变量替换功能是否正确工作
   - 测试系统模板的保护机制（不可修改/删除）
   - 验证错误处理是否统一

3. **回归测试**：
   - 验证AI功能（风险评估、模块分析、工作量评估）的提示词选择功能
   - 测试模板变更后，AI调用是否使用新模板
   - 验证前端模板管理界面在重构后正常工作

4. **边界测试**：
   - 测试缺失必填变量的错误提示
   - 测试未使用变量的警告
   - 测试无效JSON格式的错误处理
   - 测试复制不存在的模板

---

## 4. 前端枚举常量重构

**问题描述**：
前端代码中存在多处硬编码的枚举值和业务常量，需要统一管理：

- AI服务商配置在 `ModelForm.tsx` 中硬编码
- 业务规则常量（如文档长度限制5000字符）散落在组件中
- 评分颜色映射逻辑重复
- 表单验证规则重复定义

**影响**：

- 难以维护和修改业务规则
- 代码重复，违反DRY原则
- 类型不安全，容易出错

**解决方案**：

1. 创建 `frontend/ppa_frontend/src/constants/` 目录结构：
   - `aiProviders.ts` - AI服务商枚举
   - `businessRules.ts` - 业务规则常量
   - `formConfigs.ts` - 表单配置常量
   - `uiConstants.ts` - UI相关常量（颜色、样式等）
   - `index.ts` - 统一导出

2. 重构现有组件使用新的常量定义
3. 添加类型定义确保类型安全

**相关文件**：

- 需要新建：`src/constants/aiProviders.ts`
- 需要新建：`src/constants/businessRules.ts`
- 需要新建：`src/constants/formConfigs.ts`
- 需要新建：`src/constants/uiConstants.ts`
- 需要新建：`src/constants/index.ts`
- 需要修改：`src/pages/ModelConfig/Application/components/ModelForm.tsx`
- 需要修改：`src/pages/Assessment/components/AIAssessmentModal.tsx`

**测试方案**：

1. 验证所有使用常量的组件正常工作
2. 检查TypeScript类型检查是否通过
3. 验证常量变更后组件行为正确更新

---

**优先级**：高
**严重程度**：严重（违反核心架构原则）
**预计工作量**：每个问题约2-3小时
