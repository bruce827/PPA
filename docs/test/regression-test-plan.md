# PPA 回归测试方案（Alpha 阶段 → Beta/正式版前置版）

**版本**: v1.0  
**适用阶段**: Alpha 版本稳定后，每次重要改动前后的回归测试  
**覆盖范围**: 前端 Umi Max 应用、后端 Express API、SQLite 数据库、AI 集成与导出能力

---

## 1. 目标与原则

- **目标**
  - 在每次迭代（尤其是 Alpha → Beta、重大 refactor、数据库结构调整）前后，通过系统化回归测试，验证：
    - 核心评估链路「参数配置 → 模板/项目评估 → 报价计算 → 导出」功能正确、流程可闭环。
    - 计算结果、状态持久化、历史记录与导出数据之间保持一致。
    - 现有 Bugfix 未被回滚，关键流程无新回归缺陷。
    - 性能（尤其是 `POST /api/calculate`）满足 P95 ≤ 500ms 的目标。
  - 为后续自动化测试和 CI/CD 提供可复用的场景清单与分层策略。

- **测试原则**
  - **核心路径优先**：优先保证“评估主流程 + 配置中心 + 历史/模板 + 导出”稳定，其次覆盖 Dashboard、AI 配置等非阻断功能。
  - **风险驱动**：对涉及算法、数据库结构、AI 模型调用、文件导出的改动加大回归力度。
  - **分层测试**：单元测试 → API/服务集成测试 → 前端 E2E 测试 → 手工验收。
  - **数据可回放**：尽量复用 `assessment_details_json`、AI 日志文件、种子数据，保证问题可重现与回放。

---

## 2. 回归测试范围

### 2.1 前后端功能模块

- Dashboard (`/dashboard`)
  - 项目数量、平均成本、风险等级分布等统计展示。
- 新建评估 (`/assessment/new`)
  - 模板选择与预填、Step1 风险评分、Step2 工作量估算、Step3 其他成本、Step4 总览与保存。
- 历史与模板管理 (`/assessment/history`, `/assessment/detail/:id`)
  - 项目/模板列表、分页、搜索/排序、详情查看、导出、编辑与再次保存。
- 参数配置中心 (`/config`)
  - 角色与单价、风险项、差旅成本的完整 CRUD。
- 模型配置与 AI 集成 (`/model-config`, 后端 `ai*Service`)
  - 模型配置管理、连通性测试、风险评估/模块分析/一键工作量评估等 AI 功能。
- 导出模块
  - PDF / Excel 导出、内部版/外部版模板、导出日志记录。

### 2.2 后端 API 与服务

- 配置相关：`/api/config/*`、`/api/config/all`
- 项目与模板：`/api/projects`、`/api/projects/:id`、`/api/templates`
- 计算与评估：`POST /api/calculate`
- 导出：`/api/projects/:id/export/pdf|excel`
- AI：`/api/ai/*`（若已实现）
- 内部服务层：计算服务、AI 调用服务、文件日志服务、ORM/DAO 层。

### 2.3 非功能性范围

- 性能
  - `POST /api/calculate`、`/api/projects`、`/api/config/all` 在典型和高负载（项目数 100+）场景下的响应时间。
- 稳定性
  - 服务在连续多次评估、频繁导出、批量编辑配置时保持稳定，无崩溃或明显内存泄露。
- 兼容性
  - Chrome 主浏览器 + 至少 1 个备用浏览器（Edge / Safari）。

---

## 3. 回归策略与批次划分

### 3.1 回归触发条件

- 任一满足以下条件时执行“**完整回归**”：
  - 数据库结构变更（字段新增/删除/类型调整）。
  - 核心计算逻辑变更（`/api/calculate` 或项目保存时的重算逻辑）。
  - 模型配置与 AI 调用链路的重大改造。
  - 导出格式、导出模板或导出 API 的结构变化。
  - 影响路由结构或全局状态管理的前端改造。
- 对于小型 UI 调整或局部 Bugfix，可执行“**局部回归 + 核心冒烟**”：
  - 覆盖修改模块的主要场景 + 核心评估链路的一轮快速走通。

### 3.2 回归批次划分

- **批次 A：核心链路冒烟**
  - 覆盖：
    - 前端能成功访问 `/dashboard`、`/assessment/new`、`/assessment/history`。
    - 完成一次从「新建评估 → 保存 → 历史查看 → 导出」的完整流程。
  - 目标：在 30 分钟内给出“是否可继续详细回归”的结论。

- **批次 B：业务功能全面回归**
  - 覆盖：
    - 所有页面主要场景（见 `docs/prd/automated-testing-prd.md` 中的各模块测试用例）。
    - 各类边界场景（空数据、大数据、异常输入）。
  - 目标：确保功能级别无明显回归缺陷。

- **批次 C：非功能回归**
  - 覆盖：
    - API 性能抽样测试（重点 `POST /api/calculate`）。
    - 导出耗时与大数据量下的响应。
    - 基础兼容性（至少两种浏览器）。

- **批次 D：AI 与日志回归**
  - 覆盖：
    - 模型配置生效、测试按钮正常返回。
    - 风险评估/模块梳理/一键工作量调用成功，并产生日志。
    - AI 日志与导出日志的完整性与可追溯性。

---

## 4. 测试环境与数据

### 4.1 环境要求

- 前端
  - 路径：`frontend/ppa_frontend`
  - 运行端口：`http://localhost:8000`
  - 构建方式：`npm run dev` 或生产构建后静态部署（回归建议使用接近生产的打包版本）。
- 后端
  - 路径：`server`
  - 运行端口：`http://localhost:3001`
  - 数据库：
    - 回归环境使用独立的 `ppa.regression.db` 或定期重置的 `ppa.db`。
    - 测试环境使用 `ppa.test.db`（由 `npm test` 维护），避免与回归数据混用。
  - 日志：
    - `AI_LOG_ENABLED=true`，日志目录指向独立回归日志路径（避免覆盖历史日志）。
    - 导出日志目录独立，便于回归后检查。

> 注：本方案仅定义环境要求和数据准备，不包含任何实际启动或执行命令的操作。

### 4.2 测试数据准备

- 基础配置
  - 使用 `docs/prd/automated-testing-prd.md` 第 10 章的角色、风险项、差旅成本示例作为初始配置。
  - 额外增加至少 1 套“高工价角色配置”用于边界测试（验证高成本场景）。
- 模拟项目
  - **项目 A（低风险）**：参考自动化测试 PRD 中“项目A”。
  - **项目 B（高风险）**：参考自动化测试 PRD 中“项目B”。
  - **模板 T1**：基于项目 A 保存为模板，验证模板复用与数据一致性。
  - **模板 T2**：包含大量模块和复杂对接场景，用于大数据量下的性能与导出。
- AI 测试数据
  - 至少 2~3 份典型“项目说明 + 模块划分需求”的描述文本，用于评估 AI 输出的稳定性（内容可复用现有 PRD 中示例）。

---

## 5. 用例设计与覆盖矩阵

### 5.1 模块级用例覆盖（示例）

> 详细功能与用例参考 `docs/prd/automated-testing-prd.md`，本节按回归视角给出分组与优先级。

- Dashboard
  - P1：空数据展示、正常数据展示、项目新增后的统计更新。
- 新建评估
  - P0：不使用模板的完整流程（风险→工作量→其他成本→计算→保存）。
  - P0：使用模板的完整流程（模板应用→修改→重新计算→保存）。
  - P1：中途保存草稿并继续编辑。
  - P1：表单校验（必填字段、数值边界）。
  - P2：复杂模块结构（多层模块 + 多角色）。
- 历史与模板
  - P0：项目列表分页、按名称搜索、按成本/风险排序。
  - P0：项目详情页查看成本拆解与 `assessment_details_json` 关键字段。
  - P1：编辑历史项目并重新保存。
  - P1：删除项目/模板的二次确认。
- 配置中心
  - P0：角色配置 CRUD + 对计算结果的即时生效验证。
  - P0：风险项配置 CRUD + 前端风险评分表单的更新。
  - P1：差旅成本配置对 Step3 计算的影响。
- 导出
  - P0：项目详情页导出 PDF/Excel 文件成功。
  - P0：导出的总成本、成本构成与前端展示和数据库值一致。
  - P1：内部版/外部版模板字段正确填充。
  - P2：大项目（大量模块）的导出文件结构与性能。
- AI 与模型配置
  - P0：模型配置新增/编辑/设为当前后，AI 调用链路正常。
  - P1：连接测试按钮成功/失败分支的提示与日志记录。
  - P2：风险评估/模块梳理/工作量建议在典型输入上的结果合理性（主观验收）。

### 5.2 需求覆盖矩阵

- 将 `docs/PRD.md` 和 `docs/prd/automated-testing-prd.md` 中的功能需求（FR-2/3/4/5 等）列为行，回归测试用例编号为列，建立需求→用例的映射表，以确保：
  - 每个 P0/P1 需求至少有 1 条回归用例覆盖。
  - 关键计算与数据一致性相关需求有多条用例（含正向 + 反向 + 边界）。
  - 所有已知 Bugfix（见 `docs/bugfix/*`）对应至少 1 条“防回归用例”。

---

## 6. 测试级别与责任分工

- 单元测试（后端）
  - 范围：计算公式、数据校验、服务层函数。
  - 工具：Jest。
  - 责任：后端开发在提交前补充/维护。
- API/集成测试（后端）
  - 范围：`/api/*` 各端点、数据库 CRUD、跨模块调用。
  - 工具：Jest + Supertest 或 Postman/Newman。
  - 责任：后端开发/测试。
- 前端 E2E 测试
  - 范围：关键业务流程（新建评估→保存→导出），配置 CRUD，历史/模板管理。
  - 工具：Playwright/Cypress 等（未来可接入）。
  - 责任：前端开发/测试。
- 手工验收
  - 范围：AI 结果主观合理性、UI 体验、导出文件格式与视觉校验。
  - 责任：产品/使用者本人。

---

## 7. 回归执行流程

> 本节描述标准流程，仅作为操作顺序参考，不包含任何实际测试命令。

1. **变更评审**
   - 整理本次版本变更列表（代码和数据库层面），标记高风险区域。
   - 更新本方案中“回归范围”和用例优先级（如有必要）。
2. **测试环境准备**
   - 搭建或重置回归数据库。
   - 按本方案第 4 章准备配置与基础项目数据。
3. **批次 A 冒烟**
   - 快速完成一轮端到端评估、保存与导出。
   - 若冒烟不通过，先修复再继续。
4. **批次 B 业务回归**
   - 按模块执行用例，记录缺陷。
   - 优先完成 P0 → P1 → P2 用例。
5. **批次 C 非功能回归**
   - 按预设场景抽样验证性能与兼容性。
6. **批次 D AI 与日志回归**
   - 验证模型配置、AI 调用成功率与日志完整性。
7. **回归结果评审**
   - 汇总缺陷（数量、严重度、模块分布）。
   - 评估是否满足发布条件（见下一节）。

---

## 8. 进入/退出标准

### 8.1 回归启动（进入）标准

- 本次改动已经通过基本自测和代码审查。
- 数据库迁移脚本在本地或测试环境验证通过。
- 必要的单元测试/集成测试已补充并通过。

### 8.2 回归完成（退出）标准

- 所有 P0 用例通过，P1 用例通过率 ≥ 95%，P2 用例通过率 ≥ 90%。
- 所有 Blocker / Critical 级缺陷已修复并通过复测。
- `POST /api/calculate` 在典型场景下 P95 响应时间 ≤ 500ms。
- 新增/修改功能有相应文档更新（PRD 或 README 等）。

---

## 9. 风险与应对

- 数据库迁移风险
  - 应对：在回归前使用测试数据库/快照；准备迁移回滚方案。
- 计算逻辑变更风险
  - 应对：为核心公式增加单元测试和“黄金样例数据”；回归时重点比对前后版本结果。
- AI 外部依赖不稳定
  - 应对：在回归计划中区分“AI 不可用时的降级行为”；允许在模型服务异常时对主要流程做“跳过 AI、只校验非 AI 功能”的回归。
- 导出与办公软件兼容问题
  - 应对：回归中固定使用 1~2 种主流 Office 查看 PDF/Excel；遇到兼容问题及时记录并评估影响。

---

## 10. 关联文档

- 产品与功能规格
  - `docs/PRD.md`
  - `docs/prd/automated-testing-prd.md`
  - `docs/prd/calculation-logic-spec.md`
  - 其他 `docs/prd/*` 子模块 PRD（配置、Dashboard、模型配置等）
- 缺陷与修复记录
  - `docs/bugfix/BACKEND-BUGFIX-CONSOLIDATED.md`
  - `docs/bugfix/FRONTEND-BUGFIX-CONSOLIDATED.md`
- 架构与实现
  - `server/README.md`
  - `server/ARCHITECTURE.md`

> 本文档作为 PPA 项目的回归测试总方案，可在后续迭代中按版本维护（v1.0, v1.1, ...），并与具体测试脚本、自动化工具配置（如 Playwright、Jest 等）进行联动。

