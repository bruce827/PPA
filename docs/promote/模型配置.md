# 新增模块：模型配置

## 功能概述

在现有的"参数配置"模块基础上，新增"模型配置"功能，允许管理员配置项目评估所使用的计算模型和评估规则。

## 模块定位

**现有配置模块**:
- ⚙️ 参数配置 (Config)：角色管理、风险项管理、差旅成本管理

**新增模块**:
- 🧮 模型配置 (Model Config)：评估模型、计算公式、评分规则

## 功能需求

### 1. 评估模型管理

**目的**: 支持多种评估模型，适用于不同类型的项目

**功能点**:
- 创建自定义评估模型
- 配置模型适用场景（如：互联网项目、企业内部系统、移动应用等）
- 设置模型参数（风险权重、成本系数等）
- 启用/禁用模型
- 设置默认模型

### 2. 计算公式配置

**目的**: 灵活定义成本计算规则

**可配置项**:
- **人天成本计算**: 
  - 当前公式: `成本 = 工作天数 × 角色单价 / 20`
  - 可配置: 月工作日数（默认20天）
  - 可配置: 是否应用交付系数
  
- **风险成本系数**:
  - 根据风险等级调整成本
  - 高风险项目成本增加比例
  
- **运维成本计算**:
  - 人均月成本计算规则
  - 是否基于角色平均单价

### 3. 评分规则配置

**目的**: 定义风险评分的计算和分级规则

**可配置项**:
- 风险总分上限（默认200分）
- 风险等级划分阈值:
  - 低风险: < 40%
  - 中风险: 40% - 70%
  - 高风险: > 70%
- 单项风险分值上限
- 是否启用加权评分

### 4. 模板默认值配置

**目的**: 为新建评估提供合理的初始值

**可配置项**:
- 默认交付系数（1.0）
- 默认差旅月数
- 默认运维月数和人数
- 各角色的默认工时占比

## 数据库设计

### 新增表: model_configs

```sql
CREATE TABLE model_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,                    -- 模型名称
  description TEXT,                      -- 模型描述
  model_type TEXT NOT NULL,              -- 模型类型（standard/custom）
  applicable_scenarios TEXT,             -- 适用场景（JSON数组）
  is_default BOOLEAN DEFAULT 0,          -- 是否默认模型
  is_active BOOLEAN DEFAULT 1,           -- 是否启用
  
  -- 计算参数（JSON）
  calculation_params TEXT,               -- 计算参数配置
  /*
    {
      "workdays_per_month": 20,
      "apply_delivery_coefficient": true,
      "risk_cost_multiplier": {
        "low": 1.0,
        "medium": 1.1,
        "high": 1.3
      },
      "maintenance_cost_base": "avg_role_price"
    }
  */
  
  -- 评分规则（JSON）
  scoring_rules TEXT,                    -- 评分规则配置
  /*
    {
      "max_total_score": 200,
      "risk_levels": {
        "low": { "threshold": 0.4, "label": "低风险", "color": "#52c41a" },
        "medium": { "threshold": 0.7, "label": "中风险", "color": "#faad14" },
        "high": { "threshold": 1.0, "label": "高风险", "color": "#f5222d" }
      },
      "max_item_score": 10,
      "enable_weighted_scoring": false
    }
  */
  
  -- 默认值（JSON）
  default_values TEXT,                   -- 默认值配置
  /*
    {
      "delivery_coefficient": 1.0,
      "travel_months": 0,
      "maintenance_months": 12,
      "maintenance_headcount": 2,
      "role_workday_ratio": {
        "1": 0.15,  // 项目经理 15%
        "2": 0.10,  // 产品经理 10%
        "7": 0.25   // 后端开发 25%
        // ...
      }
    }
  */
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## API 接口设计

### 1. 获取模型列表
```
GET /api/models
响应: { data: ModelConfig[] }
```

### 2. 获取模型详情
```
GET /api/models/:id
响应: { data: ModelConfig }
```

### 3. 创建模型
```
POST /api/models
请求体: ModelConfig
响应: { data: ModelConfig }
```

### 4. 更新模型
```
PUT /api/models/:id
请求体: Partial<ModelConfig>
响应: { data: ModelConfig }
```

### 5. 删除模型
```
DELETE /api/models/:id
响应: { success: true }
```

### 6. 设置默认模型
```
POST /api/models/:id/set-default
响应: { success: true }
```

### 7. 获取当前激活的模型
```
GET /api/models/active
响应: { data: ModelConfig }
```

## 前端路由

- **路径**: `/config/models`
- **导航**: 左侧菜单 → 参数配置 → 模型配置

## 使用场景

### 场景1: 不同行业项目使用不同模型
- 互联网项目：风险系数较高，开发周期较短
- 传统企业项目：风险系数较低，维护周期较长
- 政府项目：合规要求高，风险评估更严格

### 场景2: 季节性调整
- 年底项目：人力成本上浮
- 假期项目：差旅成本增加

### 场景3: 试算不同模型
- 管理员可创建多个模型
- 在新建评估时选择使用哪个模型
- 对比不同模型的评估结果

## 实现优先级

- **P0 (必须)**: 
  - 基础模型管理（CRUD）
  - 默认模型设置
  - 当前模型应用到评估流程
  
- **P1 (重要)**:
  - 计算公式配置
  - 评分规则配置
  
- **P2 (可选)**:
  - 模型对比功能
  - 模型导入导出
  - 历史模型版本管理

## 与现有功能的关系

```
模型配置 (新增)
    ↓ 应用
项目评估
    ↓ 使用
参数配置 (现有)
    ├─ 角色管理
    ├─ 风险项管理
    └─ 差旅成本管理
```

**说明**: 
- 模型配置定义"如何计算"
- 参数配置提供"计算所需的数据"
- 项目评估是"计算的执行"

---

**创建日期**: 2025-10-21  
**状态**: 📝 需求设计中

---

## 子模块设计

模型配置模块包含两个独立的子模块，各自负责不同的配置功能。

### 子模块1: 模型应用管理

**功能定位**: 用户可以配置AI模型的key、host等连接信息，并选择其中一个作为当前使用的模型

**核心功能**:

1. **AI模型配置管理**
   - 添加/编辑/删除AI模型配置
   - 配置名称、描述
   - 服务商选择（OpenAI、Azure、阿里云通义千问、百度文心一言等）
   - API Key 配置
   - API Host/Endpoint 配置
   - 模型名称选择（gpt-4, gpt-3.5-turbo, qwen-max等）

2. **当前模型选择**
   - 从已配置的模型中选择一个作为当前使用模型
   - 只能有一个当前激活模型
   - 切换模型后立即生效

3. **连接测试**
   - 测试API连接是否正常
   - 验证Key是否有效
   - 显示连接状态和响应时间

4. **基础参数配置**
   - Temperature（温度参数）
   - Max Tokens（最大输出长度）
   - Timeout（请求超时时间）

**数据结构**:

```typescript
interface AIModelConfig {
  id: number;
  config_name: string;       // 配置名称，如"OpenAI GPT-4"
  description?: string;      // 配置描述
  provider: string;          // 服务商: 'openai' | 'azure' | 'qianwen' | 'wenxin' | 'other'
  api_key: string;           // API密钥（加密存储）
  api_host: string;          // API地址，如 https://api.openai.com
  model_name: string;        // 模型名称，如 gpt-4
  
  // 基础参数
  temperature: number;       // 默认 0.7
  max_tokens: number;        // 默认 2000
  timeout: number;           // 默认 30秒
  
  is_current: boolean;       // 是否为当前使用的模型
  is_active: boolean;        // 是否启用
  last_test_time?: string;   // 最后测试时间
  test_status?: string;      // 测试状态: 'success' | 'failed'
  
  created_at: string;
  updated_at: string;
}
```

**页面路由**: `/config/models/application`

**界面布局**:

```
┌─────────────────────────────────────────────────┐
│  🤖 模型配置 > 模型应用管理                      │
├─────────────────────────────────────────────────┤
│                                                  │
│  [+ 新建模型配置]              [🔍 搜索...]     │
│                                                  │
│  ┌────────────────────────────────────────────┐ │
│  │ 配置名称   │服务商│模型│状态  │操作      │ │
│  ├────────────────────────────────────────────┤ │
│  │ ⭐ OpenAI  │OpenAI│GPT-4│当前使用│[编辑]│ │
│  │   通义千问 │阿里云│qwen │ 启用  │[编辑]│ │
│  │   文心一言 │百度  │ernie│ 启用  │[编辑]│ │
│  └────────────────────────────────────────────┘ │
│                                                  │
└─────────────────────────────────────────────────┘
```

**新建/编辑表单**:

```
┌──────────────────────────────────────┐
│  新建AI模型配置                       │
├──────────────────────────────────────┤
│                                       │
│  基础信息                             │
│  配置名称*: [OpenAI GPT-4_______]    │
│  配置描述:  [生产环境使用_______]    │
│                                       │
│  服务配置                             │
│  服务商*:   [OpenAI ▼]               │
│              OpenAI                   │
│              Azure OpenAI             │
│              阿里云-通义千问          │
│              百度-文心一言            │
│              其他                     │
│                                       │
│  API Key*:  [sk-xxxxxxxxxxxxx____]   │
│  API Host*: [https://api.openai.com] │
│  模型名称*: [gpt-4 ▼]                │
│              gpt-4                    │
│              gpt-3.5-turbo            │
│              gpt-4-turbo              │
│                                       │
│  基础参数                             │
│  Temperature: [0.7___] (0.0-2.0)     │
│  Max Tokens:  [2000__]               │
│  Timeout:     [30____] 秒            │
│                                       │
│  [测试连接]                           │
│  ✓ 连接成功 (响应时间: 1.2s)         │
│                                       │
│  [取消]           [保存]             │
└──────────────────────────────────────┘
```

---

### 子模块2: 提示词模板管理

**功能定位**: 管理AI功能使用的预制提示词模板，用户可以自定义和编辑提示词

**核心功能**:

1. **提示词模板库**
   - 系统预置的提示词模板
   - 用户自定义提示词模板
   - 模板分类（风险分析、成本估算、报告生成等）
   - 模板启用/禁用

2. **提示词编辑**
   - 系统提示词（System Prompt）编辑
   - 用户提示词模板（User Prompt）编辑
   - 支持变量占位符（如 `{project_name}`, `{risk_score}`）
   - Markdown格式支持

3. **变量管理**
   - 定义可用的变量
   - 变量说明和示例
   - 变量自动提示

4. **模板测试**
   - 填入测试数据
   - 预览生成的完整提示词
   - （可选）调用AI测试效果

**数据结构**:

```typescript
interface PromptTemplate {
  id: number;
  template_name: string;      // 模板名称
  category: string;           // 分类
  description?: string;       // 模板描述
  
  system_prompt: string;      // 系统提示词
  user_prompt_template: string; // 用户提示词模板（含变量占位符）
  
  variables: Array<{          // 可用变量列表
    name: string;             // 变量名，如 project_name
    description: string;      // 变量说明
    example: string;          // 示例值
    required: boolean;        // 是否必填
  }>;
  
  is_system: boolean;         // 是否系统预置模板
  is_active: boolean;         // 是否启用
  created_at: string;
  updated_at: string;
}
```

**页面路由**: `/config/models/prompts`

**界面布局**:

```
┌─────────────────────────────────────────────────┐
│  💬 模型配置 > 提示词模板管理                    │
├─────────────────────────────────────────────────┤
│                                                  │
│  [+ 新建模板]  [📚 预置模板]  [🔍 搜索...]     │
│                                                  │
│  ┌────────────────────────────────────────────┐ │
│  │ 模板名称    │ 分类     │类型│状态│操作  │ │
│  ├────────────────────────────────────────────┤ │
│  │ 风险分析    │风险分析  │系统│启用│[查看]│ │
│  │ 成本分析    │成本估算  │系统│启用│[查看]│ │
│  │ 自定义分析  │自定义    │用户│启用│[编辑]│ │
│  └────────────────────────────────────────────┘ │
│                                                  │
└─────────────────────────────────────────────────┘
```

**提示词编辑器**:

```
┌───────────────────────────────────────────────┐
│  编辑提示词模板: 风险分析                      │
├───────────────────────────────────────────────┤
│                                                │
│  基础信息                                      │
│  模板名称*: [项目风险分析_____________]        │
│  分类*:     [风险分析 ▼]                       │
│  描述:      [基于项目数据生成风险分析]        │
│                                                │
│  系统提示词 (System Prompt)                    │
│  ┌──────────────────────────────────────────┐ │
│  │ 你是一个专业的项目风险分析专家，拥有   │ │
│  │ 15年的项目管理经验。请基于提供的项目   │ │
│  │ 信息，给出详细的风险分析和建议。       │ │
│  │                                            │ │
│  └──────────────────────────────────────────┘ │
│                                                │
│  用户提示词模板 (User Prompt Template)         │
│  提示: 使用 {变量名} 格式插入变量              │
│  ┌──────────────────────────────────────────┐ │
│  │ 项目名称: {project_name}                  │ │
│  │ 项目描述: {project_description}           │ │
│  │ 风险总分: {risk_score} / 200              │ │
│  │ 风险等级: {risk_level}                    │ │
│  │                                            │ │
│  │ 请分析以下风险评估结果，并提供：         │ │
│  │ 1. 主要风险点识别                         │ │
│  │ 2. 每个风险点的影响程度                   │ │
│  │ 3. 针对性的缓解建议                       │ │
│  │ 4. 优先级排序                             │ │
│  │                                            │ │
│  │ 风险评估详情:                             │ │
│  │ {risk_details}                            │ │
│  └──────────────────────────────────────────┘ │
│                                                │
│  变量定义                                      │
│  ┌──────────────────────────────────────────┐ │
│  │ • project_name      [必填] 项目名称      │ │
│  │ • project_description [选填] 项目描述    │ │
│  │ • risk_score        [必填] 风险总分      │ │
│  │ • risk_level        [必填] 风险等级      │ │
│  │ • risk_details      [必填] 风险详情      │ │
│  └──────────────────────────────────────────┘ │
│  [+ 添加变量]                                  │
│                                                │
│  [预览]  [取消]           [保存]              │
└───────────────────────────────────────────────┘
```

**预置模板示例**:

**1. 风险分析模板**
```yaml
template_name: 项目风险分析
category: risk_analysis
system_prompt: |
  你是一个资深的软件项目风险评估专家，拥有15年项目管理经验。
  你的任务是基于项目的风险评分数据，提供专业的风险分析和缓解建议。
  
user_prompt_template: |
  项目基本信息:
  - 项目名称: {project_name}
  - 项目描述: {project_description}
  - 风险总分: {risk_score} / 200
  - 风险等级: {risk_level}
  
  详细风险评分:
  {risk_details}
  
  请提供:
  1. 识别出的TOP 3主要风险点
  2. 每个风险点的影响分析
  3. 针对性的缓解措施（至少3条）
  4. 风险优先级排序
  
variables:
  - name: project_name
    description: 项目名称
    example: 电商平台升级项目
    required: true
  - name: project_description
    description: 项目描述
    example: 对现有电商平台进行架构升级
    required: false
  - name: risk_score
    description: 风险总分
    example: 85
    required: true
  - name: risk_level
    description: 风险等级
    example: 中风险
    required: true
  - name: risk_details
    description: 详细风险评分数据（JSON格式）
    example: {"需求明确度": 8, "技术难度": 10}
    required: true
```

**2. 成本分析模板**
```yaml
template_name: 项目成本分析
category: cost_estimation
system_prompt: |
  你是一个IT项目成本评估专家，熟悉各类软件项目的成本构成。
  你需要基于项目的成本数据，评估其合理性并提供优化建议。
  
user_prompt_template: |
  项目成本明细:
  - 研发成本: {development_cost} 万元
  - 对接成本: {integration_cost} 万元
  - 运维成本: {maintenance_cost} 万元
  - 风险成本: {risk_cost} 万元
  - 总成本: {total_cost} 万元
  
  项目规模:
  - 总工作量: {total_workdays} 人天
  
  请分析:
  1. 成本构成是否合理
  2. 是否存在成本过高或过低的项
  3. 优化建议（至少2条）
  
variables:
  - name: development_cost
    description: 研发成本（万元）
    example: 125.5
    required: true
  - name: integration_cost
    description: 系统对接成本（万元）
    example: 35.2
    required: true
  - name: maintenance_cost
    description: 运维成本（万元）
    example: 9.0
    required: true
  - name: risk_cost
    description: 风险成本（万元）
    example: 5.0
    required: true
  - name: total_cost
    description: 总成本（万元）
    example: 174.7
    required: true
  - name: total_workdays
    description: 总工作量（人天）
    example: 180
    required: true
```

---

## 数据库设计

### 表1: ai_model_configs

```sql
CREATE TABLE ai_model_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  config_name TEXT NOT NULL,           -- 配置名称
  description TEXT,                    -- 配置描述
  provider TEXT NOT NULL,              -- 服务商
  api_key TEXT NOT NULL,               -- API密钥（需加密）
  api_host TEXT NOT NULL,              -- API地址
  model_name TEXT NOT NULL,            -- 模型名称
  
  -- 基础参数
  temperature REAL DEFAULT 0.7,
  max_tokens INTEGER DEFAULT 2000,
  timeout INTEGER DEFAULT 30,
  
  is_current BOOLEAN DEFAULT 0,        -- 是否当前使用
  is_active BOOLEAN DEFAULT 1,         -- 是否启用
  last_test_time DATETIME,             -- 最后测试时间
  test_status TEXT,                    -- 测试状态
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 确保只有一个当前使用的模型
CREATE UNIQUE INDEX idx_current_model ON ai_model_configs(is_current) WHERE is_current = 1;
```

### 表2: prompt_templates

```sql
CREATE TABLE prompt_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,         -- 模板名称
  category TEXT NOT NULL,              -- 分类
  description TEXT,                    -- 模板描述
  
  system_prompt TEXT NOT NULL,         -- 系统提示词
  user_prompt_template TEXT NOT NULL,  -- 用户提示词模板
  
  variables_json TEXT,                 -- 变量定义（JSON）
  /*
    [
      {
        "name": "project_name",
        "description": "项目名称",
        "example": "项目A",
        "required": true
      }
    ]
  */
  
  is_system BOOLEAN DEFAULT 0,         -- 是否系统预置
  is_active BOOLEAN DEFAULT 1,         -- 是否启用
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_prompt_category ON prompt_templates(category);
CREATE INDEX idx_prompt_active ON prompt_templates(is_active);
```

---

## API 接口设计

### 模型应用管理接口

```
GET    /api/config/ai-models              # 获取模型配置列表
GET    /api/config/ai-models/:id          # 获取配置详情
GET    /api/config/ai-models/current      # 获取当前使用的模型
POST   /api/config/ai-models              # 创建配置
PUT    /api/config/ai-models/:id          # 更新配置
DELETE /api/config/ai-models/:id          # 删除配置
POST   /api/config/ai-models/:id/test     # 测试连接
POST   /api/config/ai-models/:id/set-current # 设为当前使用
```

### 提示词模板管理接口

```
GET    /api/config/prompts                # 获取提示词列表
GET    /api/config/prompts/:id            # 获取提示词详情
GET    /api/config/prompts/system         # 获取系统预置模板
POST   /api/config/prompts                # 创建提示词
PUT    /api/config/prompts/:id            # 更新提示词
DELETE /api/config/prompts/:id            # 删除提示词（仅用户创建的）
POST   /api/config/prompts/:id/preview    # 预览提示词（填充变量后）
```

---

## 实现优先级

### P0 (必须 - 第一期)
1. ✅ AI模型配置 - CRUD功能
2. ✅ 设置当前使用模型
3. ✅ 连接测试功能
4. ✅ 提示词模板 - CRUD功能
5. ✅ 系统预置模板

### P1 (重要 - 第二期)
6. 提示词变量管理
7. 提示词预览功能
8. API密钥加密存储
9. 模型配置导入导出

### P2 (增强 - 未来)
10. 提示词测试（调用AI）
11. 使用统计和日志
12. 多语言提示词支持
