# PPA 新建评估风险评分步骤改进 PRD

## 1. 背景与目标

- **背景**：在 2025-10-17 的自动化测试中，`/assessment/new` 页面仅出现“项目管理-项目阶段”单一下拉项。选择任意选项后，风险总分和评分因子返回 `NaN`，不存在“下一步”按钮，导致评估流程无法继续。
- **目标**：恢复并完善风险评分步骤，让用户能够完成所有风险条目选择，正确获得风险总分/评分因子，并顺利进入后续步骤。

## 2. 当前问题概述

1. **风险配置缺失**：后端接口返回的风险评估项列表为空或字段格式不符合前端预期，页面未渲染各类风险项。
2. **默认值逻辑错误**：风险总分/评分因子从空集合计算，导致 `NaN` 显示。
3. **流程阻塞**：由于校验不通过，步骤导航 `下一步` 按钮未渲染/被禁用，整个向导停留在第一步。

## 3. 需求范围

- 恢复/初始化风险评估项的数据源，确保页面至少展示一组完整的风险类别与选项。
- 前端风险评分表单需根据接口返回动态渲染多条风险项，并允许逐项选择。
- 计算逻辑需保证：
  - 所有风险项均有默认分值（如未选择需提示）。
  - 风险总分、评分因子计算结果是有效数字并实时刷新。
- 当风险项选择完整且计算成功时，应显示可点击的“下一步”按钮。
- 保持与后续工作量估算、其他成本、生成总览步骤的联动。

## 4. 功能说明

### 4.1 风险数据初始化

- **后端**：
  - 在数据库或初始化脚本中新增至少 3 类风险项（可参考 `docs/csv/项目评分.csv`），每类包含若干选项（描述+分值）。
  - `/api/config/risk-items` GET 接口返回结构需符合前端消费（字段包含 `category`、`item_name`、`options_json`）。
  - 若接口无数据，应返回明确错误或默认模板数据，而非空数组。
- **前端**：
  - 在页面加载时调用接口，按类别渲染 `ProForm` / `ProFormSelect` 列表。
  - 若接口无数据，展示提示卡片（含跳转到参数配置的入口）。

### 4.2 计算与校验

- **计算规则**：
  - 风险总分 = Σ(各风险项选项分值)。
  - 评分因子 = 风险总分 / 100，保留两位小数。
  - 所有分值采用数值类型，避免字符串拼接导致 `NaN`。
- **交互反馈**：
  - 选择项后，右侧总分与因子即时更新。
  - 若仍有未选择项，提示“请完成全部风险项选择”。
  - 当全部完成且计算成功时，`下一步` 按钮置为可点击。

### 4.3 错误处理

- 接口异常或无数据：
  - 提示“风险评估项未配置，无法继续评估”，并提供“前往参数配置”的按钮。
  - 禁止进入下一步，并记录日志。
- 计算失败：
  - 弹出 message.error，提示“风险总分计算失败，请重试或联系管理员”。

## 5. 非功能需求

- **性能**：风险项数量 ≤ 50，页面渲染与计算需在 200ms 内完成。
- **可维护性**：风险选项配置完全来源于数据库，代码不应硬编码分值。
- **兼容性**：保持与现有 `Chrome Dev MCP` 自动化脚本兼容（脚本需更新选择器以匹配实际控件）。

## 6. 验收标准

1. 页面展示至少 3 个风险类别，每个类别含多个可选项。
2. 完成所有选项选择后，风险总分与评分因子为有效数字。
3. “下一步”按钮可点击，进入工作量估算页面顺利加载。
4. 删除所有风险配置时，页面提示用户补充配置并阻止继续。
5. 自动化脚本 `docs/tests/new-assessment-chrome-mcp.json` 更新后可一次性走通四个步骤并提交成功。

## 7. 发布计划

- **开发**：1 个前端工程师 + 1 个后端工程师，预计 2 天。
- **测试**：
  - 手工回归风险评分步骤。
  - 运行更新后的 Chrome MCP 脚本，验证端到端流程。
- **上线**：与参数配置初始化脚本同步发布，确保环境自带基础数据。

## 8. 风险与依赖

- 依赖后端提供可靠的风险项数据；若仍缺少数据，需产品侧提供默认模板。
- 若已有历史项目依赖旧结构，需确认数据迁移策略，避免老项目打开时报错。
