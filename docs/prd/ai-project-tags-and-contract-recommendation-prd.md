# PPA - AI 项目标签 & 相关业绩推荐 & 业绩库（CSV）PRD

**作者**: bruce
**日期**: 2026-01-14
**版本**: 0.1 Draft

---

## Executive Summary

本 PRD 规划四个相互关联的新能力：

1. **AI 项目标签（Project Tags）**：基于项目评估的完整信息（风险、工作量、成本、描述、模块拆解等）生成一组标签，用于后续检索/归类/推荐；标签在“新建项目评估最后一步”和“历史项目详情”中均可人工增删。
2. **相关业绩推荐（Related Performance Recommendation）**：在“历史项目详情”页新增一个推荐区域，依据当前项目标签，从“历史业绩模块（CSV 合同库）”中匹配相关条目并按匹配度排序。
3. **历史业绩模块（本地 CSV 合同库）**：新增一个只读模块（挂在“项目评估”下），自动读取 `server/contracts/` 目录下所有 CSV 文件，每个文件一个 Tab，Tab 名即文件名；采用“搜索优先 + 动态列”展示（列随文件变化），仅用于查看，不提供增删改。
4. **Dashboard 统计（业绩数量）**：在 Dashboard 顶部统计卡片增加“业绩数量”，数据来源为所有 CSV 文件中的项目条目总数。

核心目标：

- 让评估结果不止是“成本数字”，还沉淀为可复用的“标签化知识”。
- 让项目详情页可快速对齐过往合同/项目业绩，辅助售前报价与方案复用。

---

## Project Classification

**Technical Type:** SaaS B2B Web 应用（Umi Max + Ant Design 前端、Express + SQLite 后端）  
**Domain:** 企业级项目组合评估与报价管理 + 业绩资料查询  
**Complexity:** 中等偏上（AI 生成、标签数据模型、推荐排序、CSV 解析与大表渲染）

---

## Success Criteria

1. **标签生成可用**
   - 生成前支持选择提示词模板并可预览最终提示词。
   - 标签可编辑并保存，刷新后仍存在。
2. **推荐有效**
   - 历史项目详情页能展示“相关业绩推荐”，并可解释（展示命中标签/匹配字段）。
   - 推荐列表可直接展示推荐条目的全量信息（动态字段全量展示），无需跳转定位。
3. **数据敏感处理**
   - 业绩模块数据不落库（不写入 SQLite），仅来源于本地 CSV 文件。
   - 推荐计算不依赖 AI（纯本地匹配），避免将敏感合同信息发送给模型。

---

## Product Scope

### MVP - Minimum Viable Product

- AI 标签：
  - 生成：用户选择提示词模板后，从项目评估信息生成标签（JSON 返回）。
  - 编辑：在两个入口（新建最后一步、历史详情）均可增删标签并保存到项目。
- 业绩库（CSV）：
  - 自动读取 `server/contracts/` 下所有 CSV 文件。
  - 每个文件一个 Tab，只读展示，采用搜索策略。
  - 表格列为动态列（按当前文件解析结果渲染）。
  - 优先使用 Ant Design Pro/Ant Design 的大数据渲染能力（虚拟滚动等），尽量不依赖分页。
- 相关业绩推荐：
  - 历史详情页展示推荐列表。
  - 以标签匹配 CSV 的动态字段，按匹配度排序，并在列表中展示推荐条目的全量字段信息。
- Dashboard：
  - 顶部统计卡片增加“业绩数量”（所有 CSV 的项目条目数总和）。

---

## Glossary / Definitions

- **项目标签（Tag）**：描述项目特征的短文本（例如：`数字孪生`、`BIM`、`智慧工厂`、`固定总价`、`某客户名`）。
- **标签类型（Tag Type）**：可选的分类维度（例如：行业/技术/业务域/交付/客户/关键词）。MVP 可仅用纯文本标签，类型作为扩展字段。
- **业绩条目（Performance Record）**：CSV 文件中的一行记录（通常对应合同/项目）。

---

## Information Architecture（模块放置建议）

你已决定：**历史业绩模块（CSV 业绩库）放在“项目评估模块”下面**。

建议信息架构：

- `项目评估`
  - `新建评估`
  - `评估历史`
  - `业绩库（CSV）`

历史项目详情页展示“相关业绩推荐”（Top N），推荐列表直接展示推荐条目的全量信息，不做跳转定位。

---

## User Experience Principles

- **AI 辅助但用户可控**：AI 只负责“建议标签”，最终以用户编辑结果为准。
- **可解释推荐**：推荐结果必须显示“为什么推荐”（命中哪些标签、命中哪些字段）。
- **敏感数据不出本地**：CSV 仅本地展示；推荐/匹配不调用 AI。

---

## User Flows

### Flow A：新建项目评估（最后一步）生成/编辑标签

1. 用户完成评估输入，进入最后一步（汇总页）。
2. 页面展示“项目标签”区域：
   - 默认显示当前项目已保存标签（新项目通常为空）。
   - 按钮：`AI 生成标签`（生成前需选择提示词模板）。
3. 点击 `AI 生成标签`：
   - 选择提示词模板（promptId）并填写变量（variables），支持预览最终提示词。
   - 二次确认“将用 AI 结果覆盖当前标签”。
   - 前端组装“项目完整信息”调用后端 AI 标签接口。
   - 返回 `tags: string[]` 后覆盖到 UI。
4. 用户可手动新增/删除标签。
5. 点击“保存/完成评估”时，标签一并保存到项目。

### Flow B：历史项目详情编辑标签 + 查看推荐

1. 用户进入 `/assessment/detail/:id`（历史详情）。
2. 页面展示：
   - 项目标签区域（可编辑、保存，支持 AI 生成）。
   - “相关业绩推荐”区域：显示 Top N 推荐条目。

3. 用户点击 `AI 生成标签`：
   - 选择提示词模板（promptId）并填写变量（variables），支持预览最终提示词。
   - 二次确认“将用 AI 结果覆盖当前标签”。
   - 调用后端 AI 标签接口，返回 `tags: string[]` 后覆盖显示。
   - 用户可继续手动增删，点击保存后持久化到项目。

4. 推荐列表刷新：
   - 以项目最新标签重新计算推荐（本地匹配，不调用 AI）。
   - 每条推荐展示：命中标签 + 推荐条目的全量字段信息（动态字段全量展示）。

#### Flow B 关键交互细节（建议写入实现时遵守）

1. **提示词模板选择**
   - 弹窗/抽屉形式（建议复用现有“提示词模板选择”交互模式）：
     - 选择模板（promptId）
     - 填写变量（variables）
     - 预览最终提示词
2. **覆盖确认**
   - 用户点击“开始生成”后，弹出确认：将覆盖当前标签。
3. **生成中状态**
   - 生成过程中禁用保存按钮与生成按钮，显示 loading。
   - 若失败，保留原标签不变，展示错误信息（不清空）。
4. **生成后可编辑**
   - 成功后用 `tags` 全量覆盖，用户可继续用标签编辑组件增删。
   - 保存成功后提示，并触发推荐刷新。
5. **推荐展示与可解释**
   - 推荐条目展示：
     - 命中标签列表
     - 推荐条目的全量字段信息（动态字段全量展示）

### Flow C：业绩库（CSV）浏览

1. 用户打开 `项目评估 > 业绩库（CSV）`。
2. 系统自动列出 `server/contracts/` 所有 CSV 文件并生成 Tabs。
3. 选中某 Tab 后加载 CSV 内容并渲染：
   - 动态列表格（按当前文件解析出的列渲染）
   - 搜索框（搜索优先）
   - 大数据虚拟渲染（尽量不依赖分页）

---

## Functional Requirements

### FR-1 AI 项目标签生成

- **FR-1.1（P0）标签生成入口**：新建评估最后一步与历史详情均提供 `AI 生成标签`。
- **FR-1.1.1（P0）提示词模板选择**：生成前必须由用户选择提示词模板（promptId），并填写可选变量（variables），支持预览最终提示词。
- **FR-1.2（P0）输入数据范围**：标签生成应尽量基于项目的“所有信息”，建议包含：
  - 项目基本信息：name/description/project_type
  - 风险：risk_scores、风险项描述
  - 工作量：development_workload、integration_workload、角色信息
  - 成本：calculate 结果（总成本、拆解、rating factor）
  - 可选：AI 模块拆解结果（如已存在）
- **FR-1.2.1（P0）发送“所有项目信息”的策略**：你希望把前几步的所有项目信息都发送给 AI。
  - 建议以 `assessment_details_json` 作为主要载体（尽量完整）。
  - 为降低模型失败率，建议对超长字段做长度控制（例如：仅保留前 N 字 + 末尾 N 字），并在提示词中注明“内容已裁剪”。
  - 建议对明显敏感/无助于标签的字段做可选脱敏或开关（例如完整客户名、合同编码等），以便在日志与 prompt 中控制泄露风险。
  - 严禁包含合同/业绩库 CSV 内容。
- **FR-1.3（P0）输出格式**：后端返回 JSON：
  - `tags: string[]`
- **FR-1.3.1（P0）标签约束**：为保证可用性与一致性，标签需满足：
  - 数量上限：单项目最多 `30` 个标签（超出则截断并提示）。
  - 文本长度：单个标签长度 `1~30` 字符（超出则截断或拒绝，需明确提示）。
  - 规范化：去首尾空格、去重、过滤空字符串。
- **FR-1.4（P0）重复生成策略**：再次点击“AI 生成标签”时采用**完全覆盖**：
  - 用最新 AI 返回的 `tags` 覆盖当前标签
  - 用户如需保留旧标签，可在覆盖后手动再补回
- **FR-1.4.1（P0）覆盖提示**：点击“AI 生成标签”前提示“将用 AI 结果覆盖当前标签”，用户二次确认后再请求。
- **FR-1.5（P0）标签编辑**：标签在 UI 上支持增删；删除后不应再次自动出现（除非用户重新生成）。
  - 推荐优先使用 Ant Design 现成能力：`Select` 的 `mode="tags"`（或 ProForm 对应组件）实现“可输入+可删除+可选择”的标签编辑。
- **FR-1.6（P0）复用模型配置 + 必须落日志**：
  - 必须复用“模型配置模块”中已设置的当前模型（Provider/API Host/API Key/timeout/max_tokens），调用方式与风险评估/模块梳理/工作量评估保持一致。
  - 所有 AI 调用必须落日志（至少包含：route、promptId、requestHash、durationMs、status、errorMessage、projectId、step）。

### FR-2 标签持久化与读取

- **FR-2.1（P0）项目数据模型**：项目需持久化标签。
  - 推荐在 `projects` 表增加 `tags_json TEXT`（存储 `string[]`，JSON 字符串）。
  - 同时将最终标签快照写入 `assessment_details_json`（用于导出与历史追踪），但以 `tags_json` 作为权威来源。
  - 一致性规则：
    - `projects.tags_json`：唯一权威数据源（读写都以此为准）。
    - `assessment_details_json.tags`：仅为快照/冗余字段，禁止作为更新来源。
    - 任意标签更新（AI 覆盖/人工编辑保存）必须在同一次更新中同时写入：
      - `tags_json`
      - `assessment_details_json.tags`（若 JSON 不可解析则以 `{}` 兜底重建，再写入 `tags`）
    - 若读取时发现 `assessment_details_json.tags` 与 `tags_json` 不一致：以前者为过期快照处理，展示与推荐均以 `tags_json` 为准。
- **FR-2.2（P0）读取**：项目历史详情接口应返回标签字段。
- **FR-2.3（P0）更新**：复用项目更新接口，允许仅更新标签（见 API Specification）。
- **FR-2.4（P0）导出一致性**：PDF/Excel 导出使用标签时：
  - 必须优先使用 `projects.tags_json`。
  - `assessment_details_json.tags` 仅作为缺省/兜底（例如历史数据尚未迁移）。

### FR-3 历史项目详情：相关业绩推荐

- **FR-3.1（P0）展示位置**：历史项目详情页底部增加“相关业绩推荐”。
- **FR-3.2（P0）输入**：以当前项目标签 `tags[]` 作为输入。
- **FR-3.3（P0）匹配数据源**：业绩库模块解析出的 CSV 行数据。
- **FR-3.4（P0）匹配字段（动态）**：由于 CSV 字段可能变化，推荐算法不依赖固定列名。
  - 将每条记录的所有字段值拼接为 `search_text`（动态字段全量拼接）。
  - `score = 命中标签数`：标签对 `search_text` 做 `includes` 命中计数。
- **FR-3.5（P0）排序规则（可解释）**：
  - 不使用权重：`score = 命中标签数`
  - 返回 Top N（默认 10）
- **FR-3.6（P0）解释信息**：每条推荐需展示：
  - 命中标签列表
  - 推荐条目的全量字段信息（动态字段全量展示）

### FR-4 历史业绩模块（CSV 合同库，仅查看）

- **FR-4.1（P0）文件自动发现**：自动获取 `server/contracts/` 下所有 `.csv` 文件列表。
- **FR-4.2（P0）每文件一个 Tab**：Tab 名称为文件名（不含路径）。
- **FR-4.3（P0）只读展示**：展示为主，不提供新增/编辑/删除。
- **FR-4.3.1（P0）动态列**：每个 CSV 文件的列为动态列：
  - 需要从文件中解析出“当前文件的列名/表头”，并以此渲染表格列。
  - 动态列解析结果应同时用于：
    - 表格列渲染（列标题）
    - 推荐内容渲染（字段名/字段值，动态字段全量展示）
- **FR-4.3.2（P0）搜索优先**：业绩库页面以搜索为主要使用方式：
  - 提供搜索输入框（支持回车/按钮触发）。
  - 搜索逻辑对动态字段全量生效（等价于对 `search_text` 搜索）。
- **FR-4.4（P0）CSV 解析兼容**：由于 CSV 可能存在：
  - 头部空行/说明行
  - 单元格含换行
  - 金额包含逗号与引号

  **【本期暂不处理 / 已知限制】**
  - 暂不实现“引号内换行”的严格 CSV 解析。
  - 暂不实现“解析失败兜底（原始文本预览 + 下载）”。
  - 说明：当前迭代优先保证“能看/能搜/能推荐”的主链路，解析兼容与兜底能力后续补齐。

  MVP 建议策略：
  - “最佳努力解析”为动态列表格；
  - 若解析失败或解析质量很差，提供“原始文本预览 + 下载”兜底。
- **FR-4.5（P0）大表性能**：大文件（例如近 1MB）加载需可用：
  - 建议前端优先使用虚拟滚动/虚拟列表能力（Ant Design Table/Ant Design Pro 相关能力），默认不分页。
  - 技术方案（需明确实现约束）：
    - 方案 A（推荐）：Ant Design `Table` + `react-window`
      - 说明：Ant Design v5 的 Table 虚拟滚动非内置，需要用 `react-window` 自定义 `components.body` 实现虚拟列表。
      - 行高约束：默认要求“固定行高”（例如 48px/54px）；列内容使用 `ellipsis`，超长内容用 tooltip/抽屉查看，避免行高自适应导致虚拟滚动失效。
    - 方案 B（备选）：Ant Design Pro `ProTable` 的虚拟滚动（若当前版本稳定可用）
      - 若虚拟滚动能力不稳定或存在兼容问题，回退到方案 A。
    - 降级策略：若表格虚拟滚动不可用或性能不足，降级为“仅展示搜索命中结果列表”（减少渲染行数）。

  **【本期暂不处理 / 已知严重问题】**
  - 当前页面实现未接入虚拟滚动（react-window / ProTable 虚拟滚动），当 CSV 列数较多且行数较大时，可能出现前端页面崩溃/卡死。
  - 复现现象（示例）：后端正常返回（例如 3398 行），但前端进入“业绩库（CSV）”页面直接崩溃。
  - 后端日志示例：
    - `[INFO] Contracts 文件列表查询成功 {"route":"GET /api/contracts/files","count":4,...}`
    - `[INFO] Contracts 文件读取成功 {"route":"GET /api/contracts/file","name":"2.销售合同登记表V202302.csv","returnedRows":3398,"matchedRows":3398,...}`
  - 后续修复方向：按方案 A/B 实现虚拟滚动，并减少单元格 tooltip/复杂渲染以降低节点数量。
- **FR-4.6（P0）行数上限**：当单个 CSV 文件数据行数超过 5000 行时：
  - 页面提示：“文件行数超过 5000 行，仅展示前 5000 行数据”。
  - 系统仅获取并渲染前 5000 行数据（不做过渡设计与复杂分段）。

- **FR-4.7（P0）CSV 解析可靠性（防串列/字段错位）**：需要补齐对“真实 CSV”的解析能力，避免出现串列、字段错位、表头识别错误等问题。
  - **FR-4.7.1（P0）RFC4180 兼容（核心）**：至少支持：
    - 引号包裹字段内的逗号不应导致分列。
    - 引号包裹字段内的换行不应导致断行。
    - 支持 `""` 作为引号转义。
  - **FR-4.7.2（P0）分隔符自动识别**：自动识别并使用分隔符（优先在 `,` / `;` / `\t` 中探测）。
  - **FR-4.7.3（P0）编码兼容**：至少支持 UTF-8（含 BOM）与 GBK/GB18030 的读取与转码。
  - **FR-4.7.4（P0）表头识别增强**：表头识别需避免将“说明行/空行/数据行”误判为表头；当无法识别表头时需返回明确错误，并提供兜底（见 FR-4.8）。

- **FR-4.8（P0）异常行纠错与诊断（可观测 + 可降级）**：
  - **FR-4.8.1（P0）列数不一致处理**：当某行列数与表头不一致时应记录异常计数，并采用明确的纠错/降级策略（策略需实现时确认）：
    - 列数 > 表头：可选“合并尾列”或“丢弃多余列”。
    - 列数 < 表头：缺失列补空。
  - **FR-4.8.2（P0）诊断信息返回**：`GET /api/contracts/file` 的 `meta` 增加诊断字段，至少包含：
    - `delimiter`：实际使用的分隔符。
    - `encoding`：识别/使用的编码。
    - `malformed_rows`：列数异常行数。
    - `repaired_rows`：纠错成功行数（如启用纠错）。
  - **FR-4.8.3（P0）解析失败兜底**：当解析失败或解析质量很差时（例如 `malformed_rows/total_rows` 超过阈值）：
    - 提供“原始文本预览（前 N 行）+ 下载”兜底。
    - 不影响其他文件 Tab 的使用。

---

## CSV 展示策略（已决定：搜索优先）

你已决定采用“搜索策略”，原因是 CSV 列结构后续可能变化。

策略约束：

- **搜索优先**：用户主要通过搜索框定位记录。
- **动态列展示**：只要能解析出当前文件的列名，就以动态列表格展示；列结构变化不影响功能。
- **推荐/搜索共用 `search_text`**：
  - 将一行记录的动态字段全量拼接为 `search_text`。
  - 推荐用标签命中计数；搜索用关键字命中（大小写不敏感）。
- **解析失败兜底**：解析失败时提供原文预览与下载。
- **行数上限**：超过 5000 行仅展示前 5000 行，并在页面提示。

---

## API Specification（建议）

### 1) AI 标签生成

- `GET /api/ai/project-tag-prompts`
  - Response：`{ success: true, data: AiPrompt[] }`
  - 说明：仅返回 category 为 `project_tagging`（或等价分类）的活跃提示词模板，供用户在生成标签前选择。

- `POST /api/ai/generate-project-tags`
  - Body（示例，允许服务端再裁剪）：
    - `{ projectId?, projectSnapshot, assessment_details_json? }`
  - Response：`{ success: true, data: { tags: string[] } }`
  - 注意：不得携带 CSV/合同库内容。

### 2) 项目标签读写

- `GET /api/projects/:id`：返回项目详情时包含 `tags_json`。
- `PATCH /api/projects/:id`（推荐，部分更新）
  - Body：`{ tags: string[] }`
  - 行为：更新 `tags_json`，并同步更新 `assessment_details_json.tags`（见 FR-2 一致性规则）。
  - Response：`{ success: true, data: { id, tags: string[] } }`（或返回完整项目对象）
- `PUT /api/projects/:id`（可选，若暂不支持 PATCH）
  - Body：`{ tags: string[] }`（允许只传 tags 做最小更新）

### 3) 业绩库 CSV

- `GET /api/contracts/files`
  - Response：`{ files: string[] }`
- `GET /api/contracts/files/:fileName`
  - Query：`?limit=5000`
  - Response（推荐，结构化，便于动态列与行数控制）：
    - `{ success: true, data: { columns: string[], rows: object[], meta: { total_rows: number, returned_rows: number, truncated: boolean } } }`
    - `rows` 为前 `limit` 行数据（默认 5000）

> 说明：虽然文件位于 `server/contracts/`，但在当前“本地单机”使用场景下，服务端仅作为本机文件读取代理；不做落库、不做上传。

### 4) 错误契约（必须明确）

- 统一失败返回：`{ success: false, code: string, error: string, data?: any }`

- `GET /api/contracts/files/:fileName`
  - 文件不存在：HTTP `404`
    - `{ success: false, error: "文件不存在", code: "FILE_NOT_FOUND" }`
  - 读取失败（IO/权限）：HTTP `500`
    - `{ success: false, error: "读取失败", code: "FILE_READ_ERROR" }`
  - CSV 解析失败：HTTP `422`
    - `{ success: false, error: "CSV 格式错误", code: "PARSE_ERROR", data: { rawPreview: string } }`

- `POST /api/ai/generate-project-tags`
  - AI 生成失败：HTTP `502`（或 `500`，但需全局一致）
    - `{ success: false, error: "生成失败", code: "AI_ERROR", data: { originalTags: string[] } }`

---

## AI 调用与日志（统一约束）

- 所有 AI 功能（风险评估/模块梳理/工作量评估/本 PRD 的项目标签生成）必须：
  - 复用“模型配置模块”中当前模型的配置
  - 复用“提示词模板管理”中的模板（由用户选择 promptId）
  - 产生可追踪的日志（requestHash、duration、status、错误信息等）

本 PRD 的项目标签生成日志应与现有 AI 日志监控模块一致，方便在监控页面按 step/route 追踪。

---

## Non-Functional Requirements

### Performance

- CSV Tab 切换：中等文件（<200KB）应在 1s 内可见；大文件需提供 loading 与虚拟滚动。
- 搜索：输入关键字后应提供明显的 loading/无结果提示，避免误以为卡死。

### Security & Privacy

- 合同/业绩 CSV 不参与 AI 请求。
- 若开启 AI 日志记录，需避免把项目中的敏感字段（例如客户全称、合同编码）直接写入 prompt（可配置开关）。

### Reliability

- CSV 读取失败（文件不存在/编码异常）应有兜底提示，不影响其他页面使用。
- 当 CSV 超过 5000 行时必须明确提示已截断，避免误解为数据缺失。

---

## Open Questions（需要你确认）

- 暂无

---

## Implementation Planning（High-Level）

### Epic 1：业绩库（CSV）模块（搜索优先 + 动态列）

- 后端：列出 contracts 文件 + 按文件读取内容。
- 前端：Tabs + 动态列 + 搜索优先 + 大数据虚拟渲染 + 解析兜底。

### Epic 2：相关业绩推荐（动态字段）

- 匹配算法：基于 `search_text` 的标签命中计分 + 排序。
- 历史详情页推荐区域：展示命中标签 + 推荐条目全量字段信息。

### Epic 3：项目标签数据模型与接口

- `projects` 增加 `tags_json` 字段（迁移 + 兼容老数据）。
- 项目详情返回与更新标签接口。

### Epic 4：AI 标签生成（复用现有 AI 能力 + 提示词选择 + 日志）

- 新增 prompt 模板 category（例如 `project_tagging`）与对应列表接口（供前端选择模板）。
- 新增后端路由与服务封装：复用当前模型配置、复用提示词变量注入、并写入 AI 调用日志。

### Epic 5：Flow B 集成与体验打磨（历史详情页）

- 覆盖确认、生成中状态、失败不清空、保存后刷新推荐。

### Epic 6：Dashboard 统计（业绩数量）

- Dashboard 顶部统计卡片新增“业绩数量”。
- 统计逻辑：汇总 `server/contracts/` 下所有 CSV 文件的项目条目行数（不含表头）。

---
