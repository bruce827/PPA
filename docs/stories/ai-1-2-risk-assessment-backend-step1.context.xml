<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>AI</epicId>
    <storyId>1.2</storyId>
    <title>AI风险评估后端接口 Step1</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/ai-1-2-risk-assessment-backend-step1.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>负责AI风控功能的后端开发人员</asA>
    <iWant>实现提示词查询和风险评估接口</iWant>
    <soThat>前端AI评估弹窗可以消费真实服务并获得结构化结果</soThat>
    <tasks>
      - 创建 ai_prompts 迁移脚本并填充默认模板种子数据
      - 实现 aiPromptService 提供带缓存的提示词读取逻辑
      - 暴露 GET /api/ai/prompts 控制器与路由, 输出标准 success/data 结构
      - 开发 aiRiskAssessmentService 负责参数校验、prompt 拼装与结果解析
      - 封装 providers/ai/openaiProvider.js 处理超时、重试与统一错误
      - 在 aiController 中映射 400/422/504/500 等状态码并写入日志
      - 若启用, 保存调用摘要到 ai_assessment_logs 便于审计
      - 编写 Jest 单测与 Supertest 集成测试涵盖成功、参数错误、解析失败、超时
      - 更新 README 或 API 文档说明新端点和所需环境变量
    </tasks>
  </story>

  <acceptanceCriteria>
    AC1: GET /api/ai/prompts 返回 success=true 与完整提示词字段 (id/name/description/content/variables/model_hint), 支持 5 分钟缓存, 失败时输出 500。
    AC2: POST /api/ai/assess-risk 校验文档长度、promptId 合法性与变量完整性, 缺失参数返回 400。
    AC3: AI Provider 调用统一设置 20 秒超时与一次指数退避重试, 超时响应 504, 其他内部错误记录日志并返回 500。
    AC4: 成功响应解析出 risk_scores、missing_risks、overall_suggestion、confidence, 同时写入模型名称、时间戳与请求摘要, 解析失败返回 422。
    AC5: 为两条接口补充单元与集成测试覆盖成功、参数错误、解析失败、超时, 并更新文档说明。
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd/ai-risk-assessment-backend-step1.md" title="AI一键风险评估后端接口 PRD（Step 1）" section="4 功能需求">
        文档定义 /api/ai/prompts 与 /api/ai/assess-risk 的请求体、响应字段和错误码处理, 并要求 200ms 提示词查询与 8s 内完成评估或超时。
      </doc>
      <doc path="docs/prd/ai-risk-assessment-backend-step1.md" title="AI一键风险评估后端接口 PRD（Step 1）" section="5 非功能需求">
        规定了请求体大小限制、超时与一次重试策略、日志字段、敏感信息脱敏和测试覆盖率需达 80% 的标准。
      </doc>
      <doc path="docs/new-assessment-ai-design-step1.md" title="新建评估 AI 风险评估设计" section="3 后端API设计">
        描述前端期望的 /api/ai/prompts 与 /api/ai/assess-risk 合同, 包含示例请求/响应字段, 说明 modal 将从该接口获取提示词配置并解析评估结果。
      </doc>
      <doc path="docs/epics.md" title="PPA项目史诗与用户故事" section="Story 2.3 风险项评分建议和缺失识别">
        史诗明确 AI 需给出风险项建议评分、缺失项和总体建议, 本故事后端接口需满足这些业务输出。
      </doc>
      <doc path="docs/tech-spec.md" title="软件项目评估系统技术规范" section="4.1 路由结构">
        说明后端使用 Express 统一路由入口, /api 下分模块挂载, 新 AI 路由需按照现有模式在 routes/index.js 中注册并复用全局错误处理。
      </doc>
    </docs>
    <code>
      <artifact path="server/index.js" kind="server" symbol="startServer" lines="1-60" reason="展示 Express 5 + SQLite 初始化流程以及全局 errorHandler 挂载顺序, 新 AI 路由需符合该启动路径。">
      </artifact>
      <artifact path="server/routes/index.js" kind="router" symbol="router.use" lines="1-20" reason="主路由文件负责将业务路由挂载到 /api 前缀, 需要在此追加 /api/ai 入口。">
      </artifact>
      <artifact path="server/services/aiTestService.js" kind="service" symbol="testOpenAI" lines="1-220" reason="提供 AI 调用的超时、重试与错误映射示例, 可复用 makeRequest 封装思路实现风险评估 Provider。">
      </artifact>
      <artifact path="server/utils/db.js" kind="utility" symbol="all|get|run" lines="1-120" reason="SQLite 操作的 Promise 封装, aiPromptService 和日志记录需复用该工具以保持一致的数据库访问模式。">
      </artifact>
      <artifact path="server/middleware/errorHandler.js" kind="middleware" symbol="errorHandler" lines="1-80" reason="全局错误处理中间件将 ValidationError 映射为 400, 其他错误为 500, 新控制器应抛出标准化错误以命中该逻辑。">
      </artifact>
      <artifact path="server/tests/dashboardAPI.test.js" kind="test" symbol="Dashboard API - Integration Tests" lines="1-200" reason="展示使用 Jest + Supertest + SQLite 测试数据库创建集成测试的基线流程, 可参照编写 AI 接口测试。">
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="express" version="5.1.0" />
        <package name="sqlite3" version="5.1.7" />
        <package name="express-validator" version="7.3.0" />
        <package name="jest" version="30.2.0" />
        <package name="supertest" version="7.1.4" />
        <package name="sinon" version="21.0.0" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - 延续 Express 5 模块化架构, 控制器与服务分层, 新路由需在 routes/index.js 挂载。
    - 数据访问通过 server/utils/db.js 提供的 Promise 封装, 确保在启动时调用 db.init 并在测试中使用独立数据库文件。
    - Provider 层必须支持 20 秒超时和一次指数退避重试, 并根据 PRD 记录 request_id、promptId、模型名称、耗时与状态。
    - 请求体大小限制 20KB, 需拒绝超长文档并规避 prompt 注入, 日志仅保留哈希/摘要。
    - 错误处理使用 ValidationError 抛出 400, 解析失败返回 422, 其他错误交由全局错误处理中间件输出。
    - 配置项从环境变量读取 (AI_PROVIDER_API_KEY, AI_PROVIDER_BASE_URL 等), 并在 README 或 .env.example 中说明。
  </constraints>

  <interfaces>
    <api name="/api/ai/prompts" kind="GET" signature="GET /api/ai/prompts" path="server/routes/ai.js">
      返回 { success: true, data: Prompt[] } 结构, 支持 5 分钟内存缓存；失败时响应 { success: false, error: '获取提示词失败' } 并写入日志。
    </api>
    <api name="/api/ai/assess-risk" kind="POST" signature="POST /api/ai/assess-risk" path="server/routes/ai.js">
      请求体包含 document, promptId, variables, currentRiskItems, currentScores；成功时返回解析后的 { success: true, data: { raw_response, parsed, model_used, timestamp } }。非法输入返回 400, 解析失败返回 422, 超时返回 504。
    </api>
    <interface name="PromptRecord" kind="SQLite Schema" signature="TABLE ai_prompts(id TEXT PRIMARY KEY, name TEXT, description TEXT, content TEXT, variables_json TEXT, model_hint TEXT, created_at TEXT, updated_at TEXT)" />
    <interface name="RiskAssessmentLog" kind="SQLite Schema" signature="TABLE ai_assessment_logs(id INTEGER PRIMARY KEY, prompt_id TEXT, model_used TEXT, request_hash TEXT, duration_ms INTEGER, status TEXT, error_message TEXT, created_at TEXT)" />
    <interface name="invokeRiskAssessment" kind="Service Function" signature="async function invokeRiskAssessment(payload: AssessRiskPayload): Promise&lt;RiskAssessmentResult&gt;" path="server/services/aiRiskAssessmentService.js" />
  </interfaces>

  <tests>
    <standards>
      后端测试使用 Jest + Supertest, 集成测试需在 NODE_ENV=test 下初始化独立 SQLite 数据库, 并满足 PRD 要求的 &lt;=500ms API 响应 (模型调用除外) 以及 80% 覆盖率目标。
    </standards>
    <locations>
      server/tests/*.test.js
    </locations>
    <ideas>
      - AC1: 使用 seeded ai_prompts 数据调用 GET /api/ai/prompts, 验证缓存前后响应时间与字段完整性。
      - AC2: 构造缺失 document 或 promptId 的 POST /api/ai/assess-risk 请求, 断言返回 400 和校验消息。
      - AC3: mock Provider 触发超时, 确认返回 504 且记录耗时字段; 触发一般错误时返回 500。
      - AC4: 提供示例 AI JSON, 验证 service 解析 risk_scores、missing_risks、overall_suggestion、confidence 并写入日志摘要。
      - AC5: 集成测试覆盖成功、参数错误、解析失败、超时四类场景, 并在 README 增加环境变量说明。
    </ideas>
  </tests>
</story-context>
